# ProcureFlow Project Structure

> **Status**: Generated by setup.and.assess.project prompt  
> **Last Updated**: 2025-11-10  
> **Persona**: DocumentationEngineer

## Overview

ProcureFlow is a **pnpm monorepo** organized as a feature-based Next.js application with infrastructure tooling. The project follows modern best practices for type safety, code organization, and developer experience.

## Monorepo Structure

```
procureflow/
├── packages/
│   ├── web/                 # Next.js 15 application (primary workspace)
│   └── infra/               # Infrastructure and deployment tooling
├── docker/                  # Docker configurations
├── .github/                 # GitHub configuration
├── .husky/                  # Git hooks
└── .guided/                 # Guided Engineering documentation
```

### Workspace Configuration

**Package Manager**: pnpm 9.15.1 (strict version)  
**Node Version**: >=18.17.0  
**Workspaces**: Defined in `pnpm-workspace.yaml`

## Web Application (`packages/web/`)

The main application is a Next.js 15 app using the App Router pattern.

### Top-Level Organization

```
packages/web/
├── src/                    # Source code
├── public/                 # Static assets
├── scripts/                # Database and utility scripts
└── [config files]          # next.config.mjs, tsconfig.json, etc.
```

### Source Structure (`src/`)

```
src/
├── app/                    # Next.js App Router
│   ├── (public)/          # Public routes (no auth)
│   ├── (app)/             # Authenticated routes
│   ├── layout.tsx         # Root layout
│   └── providers.tsx      # Client providers
│
├── features/               # Feature modules (self-contained)
│   ├── agent/
│   ├── auth/
│   ├── cart/
│   ├── catalog/
│   ├── checkout/
│   └── settings/
│
├── components/             # Shared UI components
│   ├── layout/            # Layout components
│   └── ui/                # Radix UI primitives
│
├── contexts/               # React contexts
│
├── domain/                 # Domain entities and types
│   ├── entities.ts        # Core business entities
│   └── documents.ts       # Mongoose document types
│
├── lib/                    # Shared libraries
│   ├── ai/                # LangChain & AI integrations
│   ├── auth/              # NextAuth configuration
│   ├── db/                # Database connection & schemas
│   ├── constants/         # Application constants
│   ├── logger/            # Logging utilities
│   ├── metrics/           # Prometheus metrics
│   ├── reliability/       # Circuit breaker, retry logic
│   ├── utils/             # Utility functions
│   └── validation/        # Validation schemas
│
├── hooks/                  # Custom React hooks
│
├── styles/                 # Global styles and CSS
│
└── types/                  # TypeScript type definitions
```

## Feature Module Pattern

Each feature is self-contained with a consistent structure:

```
features/<feature-name>/
├── components/             # React components
├── lib/                    # Service layer (*.service.ts)
├── index.ts                # Public API (barrel export)
├── types.ts                # Feature-specific types (optional)
└── mock.ts                 # Test fixtures (optional)
```

**Features**:

- `agent/` - AI agent chat and tool execution
- `auth/` - Authentication services
- `cart/` - Shopping cart management
- `catalog/` - Item catalog and search
- `checkout/` - Purchase request creation
- `settings/` - User settings

## App Router Organization

### Route Groups

- `(public)/` - Unauthenticated routes
  - Landing page
  - Documentation
- `(app)/` - Authenticated routes (requires session)
  - Catalog browser
  - Cart management
  - Agent chat
  - Purchase requests

### API Routes (`app/(app)/api/`)

```
api/
├── auth/                  # NextAuth endpoints
├── agent/                 # AI agent chat
├── cart/                  # Cart CRUD
├── catalog/               # Item search and CRUD
├── checkout/              # Purchase request creation
├── settings/              # User settings
└── metrics/               # Prometheus metrics endpoint
```

## Database Layer (`lib/db/`)

```
lib/db/
├── mongoose.ts            # Connection singleton
├── models.ts              # Model exports
└── schemas/               # Mongoose schemas
    ├── user.schema.ts
    ├── item.schema.ts
    ├── cart.schema.ts
    ├── purchase-request.schema.ts
    └── agent-conversation.schema.ts
```

**Pattern**:

- Schemas define Mongoose models
- Domain entities (in `domain/entities.ts`) are framework-agnostic
- Services accept and return domain entities, not Mongoose documents

## Scripts (`packages/web/scripts/`)

Database and setup utilities run with `tsx`:

- `create-text-index.ts` - Create MongoDB text index for search
- `seed-office-items.ts` - Populate catalog with 200 test items
- `seed-initial-user.ts` - Create admin user
- `seed-fruits.ts` - Additional test data

**Execution**: `pnpm --filter web db:<script-name>`

## Infrastructure (`packages/infra/`)

```
packages/infra/
├── docker/                # Dockerfiles
│   └── Dockerfile.web     # Multi-stage web build
├── env/                   # Environment templates
└── pulumi/gcp/            # GCP deployment (Pulumi)
```

## Configuration Files

### Root Level

- `package.json` - Monorepo scripts and devDependencies
- `pnpm-workspace.yaml` - Workspace configuration
- `tsconfig.json` - Shared TypeScript config
- `commitlint.config.cjs` - Conventional commit enforcement
- `docker-compose.yml` - Local development stack

### Web Package

- `next.config.mjs` - Next.js configuration
- `tsconfig.json` - TypeScript configuration with path aliases
- `tailwind.config.ts` - Tailwind CSS configuration
- `eslint.config.mjs` - ESLint rules (Next.js + TypeScript)
- `postcss.config.mjs` - PostCSS configuration
- `components.json` - shadcn/ui configuration

## Path Aliases (TypeScript)

Configured in `packages/web/tsconfig.json`:

- `@/*` → `src/*` (general imports)
- `@/app/*` → `src/app/*`
- `@/components/*` → `src/components/*`
- `@/lib/*` → `src/lib/*`
- `@/styles/*` → `src/styles/*`

**Usage**: `import { connectDB } from '@/lib/db/mongoose'`

## Key Patterns

### Service Layer

Business logic lives in `*.service.ts` files within features:

- Database-agnostic interfaces (domain entities in/out)
- Framework-agnostic (usable in API routes, server components, jobs)
- Custom error classes for validation and business rules

### Route Handlers

Thin wrappers around service layer:

1. Extract and validate request data
2. Get session (authentication)
3. Call service function
4. Return formatted response

### Component Organization

- **Server Components by default** (Next.js 15)
- Use `'use client'` only when needed (hooks, interactivity)
- Shared UI from `components/ui/` (Radix primitives)
- Layout components in `components/layout/`

## Import Conventions

✅ **Correct**:

```typescript
import { searchItems } from '@/features/catalog';
import { connectDB } from '@/lib/db/mongoose';
import { Button } from '@/components/ui/button';
```

❌ **Avoid**:

```typescript
import { searchItems } from '@/features/catalog/lib/catalog.service';
import mongoose from 'mongoose'; // Use models from @/lib/db/models
```

## Development Workflow

1. **Start dev server**: `pnpm dev` (from root)
2. **Database setup**: `pnpm --filter web db:create-text-index`
3. **Seed data**: `pnpm --filter web db:seed-office-items`
4. **Lint**: `pnpm lint` (from root)
5. **Type check**: `pnpm --filter web type-check`

## Build & Deployment

- **Build**: `pnpm build` → Generates `.next/` directory
- **Production**: `pnpm start` → Runs production server
- **Docker**: Multi-stage build in `packages/infra/docker/Dockerfile.web`
- **Cloud**: Pulumi IaC for GCP deployment

## Future Organization Considerations

As the project grows, consider:

- Extracting shared types to `@procureflow/types` package
- Creating `@procureflow/domain` package for cross-app entities
- Adding `@procureflow/ui` for shared component library
- Separating admin/buyer apps if scope diverges

## Related Documentation

- Technology stack details: `.guided/architecture/stack.md`
- Domain model: `.guided/architecture/entities.md`
- Architecture boundaries: `.guided/architecture/context.md`
- Development setup: `.guided/base/setup.instructions.md`
