name: CI - Lint and Test

# Trigger on pull requests and pushes to main/dev branches
on:
  pull_request:
    branches:
      - main
      - dev
      - feat/**
  push:
    branches:
      - main
      - dev

# Cancel old CI runs when new commits are pushed
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.21.0'

jobs:
  # ==============================================================================
  # Job 1: Lint
  # ==============================================================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm --filter web lint

      - name: Run Prettier check
        run: pnpm lint:prettier

  # ==============================================================================
  # Job 2: Test (runs in parallel with lint)
  # ==============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test:run

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: packages/web/coverage/
          retention-days: 7

  # ==============================================================================
  # Job 3: Build Check
  # ==============================================================================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Build documentation
        run: pnpm build:docs

  # ==============================================================================
  # Job 4: Build and Push Docker Image (only on main branch)
  # ==============================================================================
  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [lint, test, build]
    permissions:
      contents: read
      id-token: write # Required for OIDC authentication
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tag }}
    env:
      GCP_REGION: 'us-central1'
      ARTIFACT_REPO: 'procureflow'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image metadata
        id: meta
        run: |
          TAG="sha-$(git rev-parse --short HEAD)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated image tag: $TAG"

      - name: Authenticate to Google Cloud (OIDC)
        if: vars.GCP_WORKLOAD_IDENTITY_PROVIDER != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Authenticate to Google Cloud (Service Account Key)
        if: vars.GCP_WORKLOAD_IDENTITY_PROVIDER == ''
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build
        run: |
          IMAGE_URL="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/web"
          CACHE_URL="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/web-cache"
          GIT_COMMIT_SHA=$(git rev-parse HEAD)

          # Build with buildx for cache support
          docker buildx build \
            -f packages/infra/docker/Dockerfile.web \
            --build-arg GIT_COMMIT_SHA=$GIT_COMMIT_SHA \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VERSION=${{ steps.meta.outputs.tag }} \
            --cache-from type=registry,ref=$CACHE_URL:latest \
            --cache-to type=registry,ref=$CACHE_URL:latest,mode=max \
            --push \
            --iidfile /tmp/image-digest.txt \
            -t $IMAGE_URL:${{ steps.meta.outputs.tag }} \
            -t $IMAGE_URL:latest \
            .

          # Extract image digest for deployment verification
          DIGEST=$(cat /tmp/image-digest.txt)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "Built image: $IMAGE_URL:${{ steps.meta.outputs.tag }}"
          echo "Image digest: $DIGEST"

  # ==============================================================================
  # Job 5: Trigger Deploy Workflow (build-once-promote-many)
  # ==============================================================================
  deploy:
    name: Trigger Deployment
    needs: docker
    uses: ./.github/workflows/deploy-gcp.yml
    with:
      image-tag: ${{ needs.docker.outputs.image-tag }}
      image-digest: ${{ needs.docker.outputs.image-digest }}
    secrets: inherit
