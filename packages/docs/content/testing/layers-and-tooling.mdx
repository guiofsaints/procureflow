# Layers & Tooling

Test layers, tools, and execution strategies.

## Test Layers

### Unit Tests (70%)

**Purpose**: Test business logic in isolation

**Tools**:
- Vitest 4.0.8 (test runner)
- Vitest mocks for dependencies

**Scope**:
- Service layer functions
- Domain validation
- Utility functions
- Error handling

**Example**:

```typescript
// src/features/catalog/lib/__tests__/catalog.service.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { createItem } from '../catalog.service';

describe('createItem', () => {
  it('should create item with valid data', async () => {
    const data = {
      name: 'Office Chair',
      category: 'Furniture',
      description: 'Ergonomic chair',
      estimatedPrice: 299.99,
    };

    const item = await createItem(data, 'user123');

    expect(item).toMatchObject({
      name: 'Office Chair',
      category: 'Furniture',
      status: 'Active',
      createdByUserId: 'user123',
    });
  });
});
```

### Integration Tests (25%)

**Purpose**: Test API routes with real database

**Tools**:
- Vitest
- mongodb-memory-server (in-memory MongoDB)
- Testing Library (React components)

**Scope**:
- API route handlers
- Database queries
- Authentication flows
- Agent tool execution

**Example**:

```typescript
// src/test/integration/catalog.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { MongoMemoryServer } from 'mongodb-memory-server';
import mongoose from 'mongoose';

let mongoServer: MongoMemoryServer;

beforeAll(async () => {
  mongoServer = await MongoMemoryServer.create();
  await mongoose.connect(mongoServer.getUri());
});

afterAll(async () => {
  await mongoose.disconnect();
  await mongoServer.stop();
});

describe('POST /api/items', () => {
  it('should create item and return 201', async () => {
    const response = await fetch('http://localhost:3000/api/items', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ /* item data */ }),
    });

    expect(response.status).toBe(201);
    const item = await response.json();
    expect(item).toHaveProperty('id');
  });
});
```

### E2E Tests (5% - future)

**Purpose**: Test critical user journeys end-to-end

**Tools** (planned):
- Playwright
- Real MongoDB test instance

**Scope**:
- Search → Cart → Checkout flow
- Agent conversational procurement
- Login → Session persistence

---

## Running Tests

```bash
# All tests
pnpm test

# Unit only
pnpm test:unit

# Integration only
pnpm test:integration

# With coverage
pnpm test:coverage

# Watch mode
pnpm test:watch

# Specific file
pnpm test catalog.test.ts
```

---

## Test Configuration

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['node_modules/', 'src/test/'],
      thresholds: {
        lines: 60,
        functions: 60,
        branches: 60,
        statements: 60,
      },
    },
  },
});
```

---

## References

- **[Testing Overview](/testing)** - Strategy and goals
- **[CI Gates](/testing/ci-gates)** - Automated checks

---

**Last Updated**: 2025-11-12  
**Owner**: QA + Engineering Teams
