# Runbook: Autoscaling Check

Monitor and verify Cloud Run autoscaling behavior.

## Metadata

- **Owner**: Platform Team
- **Estimated Duration**: 10-15 minutes
- **Complexity**: ðŸŸ¢ Low
- **Last Verified**: Nov 12, 2025

## Prerequisites

- [ ] GCP project access (Cloud Run Viewer role minimum)
- [ ] gcloud CLI installed and authenticated
- [ ] Access to Cloud Console

---

## Procedure

### Step 1: Check Current Instance Count

```powershell
# Get current instance count
gcloud run services describe procureflow-web \
  --region=us-central1 \
  --format='value(status.traffic[0].latestRevision, spec.template.spec.containerConcurrency, spec.template.metadata.annotations.autoscaling\.knative\.dev/minScale, spec.template.metadata.annotations.autoscaling\.knative\.dev/maxScale)'
```

**Expected Output** (Dev):

```
true
80
0
2
```

**Verification**:

- [ ] Container concurrency: 80
- [ ] Min instances: 0 (dev) or 1 (prod)
- [ ] Max instances: 2 (dev) or 100 (prod)

### Step 2: Monitor Active Instances

```powershell
# View instance count over time
gcloud monitoring time-series list \
  --filter='metric.type="run.googleapis.com/container/instance_count" AND resource.labels.service_name="procureflow-web"' \
  --format='table(metric.labels.state, points[].value.int64Value, points[].interval.endTime)'
```

**Verification**:

- [ ] Instance count within min/max limits
- [ ] Instances scaling appropriately with traffic

### Step 3: Check Request Metrics

```powershell
# View request count
gcloud monitoring time-series list \
  --filter='metric.type="run.googleapis.com/request_count" AND resource.labels.service_name="procureflow-web"' \
  --format='table(points[].value.int64Value, points[].interval.endTime)' \
  --start-time=$(Get-Date).AddHours(-1).ToString("o")
```

**Verification**:

- [ ] Request count matches expected traffic
- [ ] No sudden spikes or drops

### Step 4: Verify Latency Metrics

```powershell
# Check P95 latency
gcloud monitoring time-series list \
  --filter='metric.type="run.googleapis.com/request_latencies" AND resource.labels.service_name="procureflow-web"' \
  --format='table(points[].value.distributionValue.mean, points[].interval.endTime)' \
  --start-time=$(Get-Date).AddHours(-1).ToString("o")
```

**Target**: P95 latency < 2s

**Verification**:

- [ ] Latency within acceptable range
- [ ] No degradation over time

### Step 5: Check Scaling Events

Via Cloud Console:

1. Navigate to **Cloud Run** â†’ **procureflow-web**
2. Click **Metrics** tab
3. View:
   - Instance count graph
   - Request count graph
   - Request latency graph
   - Container CPU utilization
   - Container memory utilization

**Look for**:

- Scaling events correlate with traffic changes
- No instance thrashing (rapid up/down)
- CPU/memory within limits

---

## Verification

**Health Checks**:

- [ ] Instance count appropriate for traffic
- [ ] Scaling responsive (up in less than 30s, down after 15 min idle)
- [ ] P95 latency < 2s
- [ ] CPU utilization < 80%
- [ ] Memory utilization < 80%
- [ ] No cold start issues (if min instances > 0)

**Cost Checks**:

- [ ] Instance hours within budget
- [ ] No runaway scaling (max instances not hit)

---

## Common Issues

### Instance Count Stuck at Max

**Symptom**: Instance count = max instances for extended period

**Action**:

1. Check if legitimate traffic spike
2. Review max instance limit (may need increase for prod)
3. Check for resource bottlenecks (CPU/memory)

### High Cold Start Latency

**Symptom**: P95 latency > 3s, min instances = 0

**Action**:

1. Consider increasing min instances to 1
2. Optimize Next.js bundle size
3. Review database connection pooling

### Instance Thrashing

**Symptom**: Instance count rapidly up/down

**Action**:

1. Check if traffic is bursty
2. Adjust target concurrency (increase for more stability)
3. Review scale-down delay settings

---

## Adjustment Procedures

### Increase Max Instances

```powershell
# Update max instances
gcloud run services update procureflow-web \
  --max-instances=10 \
  --region=us-central1
```

### Enable Min Instances (Prod)

```powershell
# Set min instances to 1 (avoid cold starts)
gcloud run services update procureflow-web \
  --min-instances=1 \
  --region=us-central1
```

### Adjust Target Concurrency

```powershell
# Update container concurrency
gcloud run services update procureflow-web \
  --concurrency=100 \
  --region=us-central1
```

**Note**: Test adjustments in dev before applying to production

---

## Cost Analysis

### Calculate Monthly Cost

```powershell
# Estimate based on instance hours
# Dev: 0 min instances, 2 max
# Assumption: Average 0.1 instances running (scale-to-zero)
# Cost: $0.024/hour Ã— 0.1 Ã— 730 hours/month = ~$1.75/month

# Prod: 1 min instance, 100 max
# Assumption: Average 5 instances running
# Cost: $0.024/hour Ã— 5 Ã— 730 hours/month = ~$87.60/month
```

**Check Actual Cost**:

1. Navigate to **Billing** â†’ **Reports**
2. Filter by **Cloud Run** service
3. Review last 30 days

**Verification**:

- [ ] Cost within budget ($10/month dev, $50/month prod)
- [ ] No unexpected charges

---

## References

- **[Autoscaling Policy](/operations/autoscaling)** - Complete autoscaling documentation
- **[Deployment Strategy](/operations/deploy)** - Deployment configuration
- **[Infrastructure](/tech/infrastructure)** - Technical architecture

---

**Last Updated**: Nov 12, 2025  
**Status**: âœ… Verified
