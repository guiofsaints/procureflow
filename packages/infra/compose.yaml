# ProcureFlow Docker Compose Configuration
# Supports profiles: prod, dev, debug
# Requires env files: packages/infra/env/.env.web and .env.mongo

name: procureflow

services:
  # ============================================================================
  # Next.js Web Application
  # ============================================================================
  web:
    build:
      context: ../..
      dockerfile: packages/infra/docker/Dockerfile.web
    container_name: procureflow-web
    ports:
      - '3000:3000'
    env_file:
      - env/.env.web
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - procureflow-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - prod
      - dev

  # ============================================================================
  # MongoDB Database
  # ============================================================================
  mongo:
    # Pinned to SHA256 digest for security and reproducibility (mongo:7.0 as of 2025-11-11)
    image: mongo:7.0@sha256:a814f930db8c4514f5fe5dc3e489f58637fb7ee32a7b9bb0b7064d3274e90b8e
    container_name: procureflow-mongo
    ports:
      - '27017:27017'
    env_file:
      - env/.env.mongo
    volumes:
      - mongo_data:/data/db
      - ../../packages/infra/docker/mongo-init:/docker-entrypoint-initdb.d
    networks:
      - procureflow-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    profiles:
      - prod
      - dev
      - debug

  # ============================================================================
  # Mongo Express (Database Admin UI - Debug Only)
  # ============================================================================
  mongo-express:
    # Pinned to SHA256 digest for security and reproducibility (mongo-express:1.0.0 as of 2025-11-11)
    image: mongo-express:1.0.0@sha256:52f18378afac432973cbd36086a7ca2357c983af39f0e24c3e21c151663e417a
    container_name: procureflow-mongo-express
    ports:
      - '8081:8081'
    env_file:
      - env/.env.mongo
    environment:
      # Load credentials from mongo env_file with defaults to prevent warnings
      - ME_CONFIG_MONGODB_ADMINUSERNAME=${MONGO_INITDB_ROOT_USERNAME:-admin}
      - ME_CONFIG_MONGODB_ADMINPASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-password}
      # Explicit authSource for root user authentication
      - ME_CONFIG_MONGODB_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME:-admin}:${MONGO_INITDB_ROOT_PASSWORD:-password}@mongo:27017/?authSource=admin
      - ME_CONFIG_BASICAUTH=false
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - procureflow-network
    restart: unless-stopped
    profiles:
      - debug

# ============================================================================
# Volumes
# ============================================================================
volumes:
  mongo_data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  procureflow-network:
    driver: bridge
