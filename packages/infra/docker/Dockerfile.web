# Multi-stage Dockerfile for Next.js production build in pnpm monorepo
# Optimized for ProcureFlow with corepack, cache mounts, and security best practices

# ============================================================================
# Base Stage: Set up Node.js with corepack and pnpm
# ============================================================================
FROM node:20-alpine AS base

# Install curl for healthchecks (Alpine minimal)
RUN apk add --no-cache curl

# Enable corepack for pnpm (built-in package manager)
RUN corepack enable && corepack prepare pnpm@latest --activate

# Set working directory
WORKDIR /app

# ============================================================================
# Builder Stage: Install dependencies and build application
# ============================================================================
FROM base AS builder

# Copy monorepo manifests for dependency installation
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages/web/package.json ./packages/web/
COPY tsconfig.json ./

# Install dependencies with pnpm cache mount for faster rebuilds
# Cache location: /root/.local/share/pnpm/store
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
  pnpm install --frozen-lockfile

# Copy root node_modules to make packages resolvable for Turbopack
# This is required for Next.js 16 Turbopack in monorepo setups
RUN ln -s /app/node_modules /app/packages/web/node_modules

# Copy application source code
COPY packages/web ./packages/web

# Build Next.js application (outputs to .next/standalone)
# Build from packages/web directory with node_modules accessible from root
# Set Turbopack root to /app for monorepo support
WORKDIR /app/packages/web
ENV NEXT_PRIVATE_TURBOPACK_ROOT=/app
RUN pnpm build

# ============================================================================
# Runner Stage: Minimal production runtime
# ============================================================================
FROM node:20-alpine AS runner

# Install curl for healthcheck (compose-based)
RUN apk add --no-cache curl

# Set production environment
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Create non-root user for security
RUN addgroup --system --gid 1001 nodejs && \
  adduser --system --uid 1001 nextjs

WORKDIR /app

# Copy Next.js standalone output from builder
# Standalone includes minimal dependencies and server.js entry point
COPY --from=builder --chown=nextjs:nodejs /app/packages/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/packages/web/.next/static ./.next/static
COPY --from=builder --chown=nextjs:nodejs /app/packages/web/public ./public

# Switch to non-root user
USER nextjs

# Expose application port
EXPOSE 3000

# Configure server binding
ENV HOSTNAME="0.0.0.0"
ENV PORT=3000

# Start application (standalone server.js)
CMD ["node", "server.js"]