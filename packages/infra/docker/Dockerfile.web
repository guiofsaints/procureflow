# Multi-stage Dockerfile for Next.js production build in pnpm monorepo
# Optimized for ProcureFlow with corepack, cache mounts, and security best practices

# ============================================================================
# Base Stage: Set up Node.js with corepack and pnpm
# ============================================================================
# Pinned to SHA256 digest for security and reproducibility (node:20-alpine as of 2025-11-11)
FROM node:20-alpine@sha256:6178e78b972f79c335df281f4b7674a2d85071aae2af020ffa39f0a770265435 AS base

# Install curl for healthchecks and git for build info (Alpine minimal)
RUN apk add --no-cache curl git

# Enable corepack for pnpm (built-in package manager)
RUN corepack enable && corepack prepare pnpm@latest --activate

# Set working directory
WORKDIR /app

# ============================================================================
# Docs Builder Stage: Build documentation with Nextra
# ============================================================================
FROM base AS docs-builder

# Copy monorepo manifests for dependency installation
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages/docs/package.json ./packages/docs/
COPY tsconfig.json ./

# Install docs dependencies with pnpm cache mount
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
  pnpm install --filter @procureflow/docs --frozen-lockfile

# Copy documentation source
COPY packages/docs ./packages/docs

# Build documentation (outputs to packages/docs/out)
WORKDIR /app/packages/docs
RUN pnpm build:prod

# ============================================================================
# Builder Stage: Install dependencies and build application
# ============================================================================
FROM base AS builder

# Copy monorepo manifests for dependency installation
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages/web/package.json ./packages/web/
COPY tsconfig.json ./

# Install dependencies with pnpm cache mount for faster rebuilds
# Cache location: /root/.local/share/pnpm/store
# Use --shamefully-hoist to ensure Next.js can find all dependencies
# This flattens the node_modules structure for better compatibility with Next.js/Turbopack
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
  pnpm install --frozen-lockfile --shamefully-hoist

# Copy application source code
COPY packages/web ./packages/web

# Copy built documentation from docs-builder stage
COPY --from=docs-builder /app/packages/docs/out ./packages/web/public/docs

# Build arguments for version info
ARG GIT_COMMIT_SHA=unknown
ARG BUILD_DATE
ARG VERSION

# Set build-time environment variables
ENV GIT_COMMIT_SHA=${GIT_COMMIT_SHA} \
    NEXT_PUBLIC_GIT_COMMIT_SHA=${GIT_COMMIT_SHA} \
    NEXT_PUBLIC_BUILD_DATE=${BUILD_DATE} \
    NEXT_PUBLIC_APP_VERSION=${VERSION}

# Build Next.js application (outputs to .next/standalone)
# Build from packages/web directory with hoisted node_modules
# Set Turbopack root to /app for monorepo support
WORKDIR /app/packages/web
ENV NEXT_PRIVATE_TURBOPACK_ROOT=/app
# Suppress AI key warnings during build (keys configured at runtime)
ENV OPENAI_API_KEY=build-time-placeholder
RUN pnpm build

# ============================================================================
# Runner Stage: Minimal production runtime
# ============================================================================
# Pinned to SHA256 digest for security and reproducibility (node:20-alpine as of 2025-11-11)
FROM node:20-alpine@sha256:6178e78b972f79c335df281f4b7674a2d85071aae2af020ffa39f0a770265435 AS runner

# Install curl for healthcheck (compose-based)
RUN apk add --no-cache curl

# Set production environment
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Create non-root user for security
RUN addgroup --system --gid 1001 nodejs && \
  adduser --system --uid 1001 nextjs

WORKDIR /app

# Copy Next.js standalone output from builder
# Standalone includes minimal dependencies and server.js entry point
COPY --from=builder --chown=nextjs:nodejs /app/packages/web/.next/standalone ./
# Static files need to be in packages/web/.next/static for standalone server
COPY --from=builder --chown=nextjs:nodejs /app/packages/web/.next/static ./packages/web/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/packages/web/public ./packages/web/public

# Switch to non-root user
USER nextjs

# Expose application port
EXPOSE 3000

# Configure server binding
ENV HOSTNAME="0.0.0.0"
ENV PORT=3000

# Start application (standalone server.js is in packages/web/)
CMD ["node", "packages/web/server.js"]